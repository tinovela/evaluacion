<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImproTracker v1.0 - Bit√°cora del Director</title>
    
    <!-- React y ReactDOM (El motor de la app) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Traductor para que el navegador entienda React) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (Estilos y dise√±o bonito) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Ajustes finos para la impresi√≥n y scroll */
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-break { page-break-inside: avoid; }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen overflow-hidden">

    <!-- Aqu√≠ se montar√° nuestra aplicaci√≥n -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS (SVG) ---
        const Icon = ({ path, size = 18, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Save: (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            UserPlus: (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></>} />,
            Download: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            ChevronDown: (props) => <Icon {...props} path={<polyline points="6 9 12 15 18 9"/>} />,
            ChevronUp: (props) => <Icon {...props} path={<polyline points="18 15 12 9 6 15"/>} />,
            Info: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></>} />,
            Copy: (props) => <Icon {...props} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />,
            Upload: (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            AlertTriangle: (props) => <Icon {...props} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />,
            MessageSquare: (props) => <Icon {...props} path={<><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>} />,
            FileText: (props) => <Icon {...props} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />,
        };

        // --- DATOS Y CRITERIOS ---
        const CRITERIA = [
          {
            id: 'cimientos',
            title: '1. LOS CIMIENTOS (T√©cnica B√°sica)',
            description: 'Lo que debe estar s√≠ o s√≠ para que la impro exista.',
            items: [
              { id: 'aceptacion', label: 'Aceptaci√≥n Radical ("S√≠, y...")', desc: '¬øAcepta ideas al instante o bloquea? ¬øConstruye sobre lo ajeno?' },
              { id: 'escucha', label: 'Escucha Global', desc: '¬øEscucha texto y cuerpo? ¬øRecuerda nombres y datos del inicio?' },
              { id: 'propuesta', label: 'Propuesta (Motor)', desc: '¬øAporta "ladrillos" a la escena o solo acompa√±a pasivamente?' },
              { id: 'aqui_ahora', label: 'El "Aqu√≠ y Ahora"', desc: '¬øEst√° presente o pensando en qu√© decir despu√©s?' }
            ]
          },
          {
            id: 'estructura',
            title: '2. LA ESTRUCTURA (Narrativa)',
            description: 'Importante para formatos complejos y storytelling.',
            items: [
              { id: 'plataforma', label: 'Plataforma (CIME / PROL)', desc: '¬øDefine r√°pido Qui√©n, D√≥nde y Qu√©? ¬øEstablece relaciones?' },
              { id: 'narrativa', label: 'Narrativa (Curva Dram√°tica)', desc: '¬øDetecta planteamiento, conflicto y desenlace? ¬øSabe cu√°ndo cortar?' },
              { id: 'reincorporacion', label: 'Reincorporaci√≥n (Callback)', desc: '¬øTrae elementos del pasado para cerrar c√≠rculos?' },
              { id: 'estatus', label: 'Estatus', desc: '¬øManeja cambios de poder? ¬øVar√≠a su estatus o juega siempre igual?' }
            ]
          },
          {
            id: 'actor',
            title: '3. EL ACTOR EN ESCENA',
            description: 'La impro es teatro, interpretaci√≥n y cuerpo.',
            items: [
              { id: 'espacio_objetos', label: 'Uso del Espacio y Objetos', desc: '¬øLos objetos tienen peso/consistencia? ¬øUsa todo el escenario?' },
              { id: 'corporalidad', label: 'Corporalidad del Personaje', desc: '¬øCambia postura, caminar y energ√≠a? ¬øDiferente a s√≠ mismo?' },
              { id: 'emocionalidad', label: 'Emocionalidad', desc: '¬øTransita emociones reales o las act√∫a mentalmente? ¬øEs vulnerable?' },
              { id: 'voz', label: 'Voz y Proyecci√≥n', desc: '¬øSe entiende? ¬øUsa matices vocales?' }
            ]
          },
          {
            id: 'vicios',
            title: '4. VICIOS A CORREGIR',
            description: 'Puntos ciegos que impiden crecer.',
            items: [
              { id: 'cabezas_parlantes', label: 'Cabezas Parlantes', desc: '¬øHabla del problema en lugar de accionar f√≠sicamente?' },
              { id: 'cliche', label: 'Originalidad vs. Clich√©', desc: '¬øRecurre a estereotipos o chistes f√°ciles (sexo, violencia)?' },
              { id: 'pregunton', label: 'Pregunt√≥n (Wimping)', desc: '¬øHace demasiadas preguntas obligando al otro a construir solo?' },
              { id: 'gagging', label: 'Gagging (Chisteo)', desc: '¬øRompe la realidad por la risa r√°pida? ¬øSe r√≠e de s√≠ mismo?' },
              { id: 'bloqueo', label: 'Conflictos de "No"', desc: '¬øConfunde conflicto con discutir o negar?' }
            ]
          },
          {
            id: 'actitud',
            title: '5. ACTITUD Y GRUPO',
            description: 'El "Juego Interno" y la salud del elenco.',
            items: [
              { id: 'support', label: 'Compa√±erismo (Support)', desc: '¬øHace brillar a otros? ¬øSalva escenas o deja morir al compa√±ero?' },
              { id: 'riesgo', label: 'Riesgo y Error', desc: '¬øSe lanza al vac√≠o? ¬øIntegra el error con alegr√≠a?' },
              { id: 'critica', label: 'Recepci√≥n de Cr√≠tica', desc: '¬øSe justifica o escucha y aplica las correcciones?' }
            ]
          }
        ];

        // --- COMPONENTE SEM√ÅFORO ---
        const TrafficLight = ({ value, onChange }) => {
          return (
            <div className="flex gap-2">
              <button
                onClick={() => onChange('red')}
                className={`w-8 h-8 rounded-full border-2 transition-all ${
                  value === 'red' 
                    ? 'bg-red-500 border-red-700 shadow-[0_0_10px_rgba(239,68,68,0.6)] scale-110' 
                    : 'bg-red-100 border-red-200 hover:bg-red-200 opacity-60'
                }`}
                title="A trabajar/Corregir"
              />
              <button
                onClick={() => onChange('yellow')}
                className={`w-8 h-8 rounded-full border-2 transition-all ${
                  value === 'yellow' 
                    ? 'bg-yellow-400 border-yellow-600 shadow-[0_0_10px_rgba(250,204,21,0.6)] scale-110' 
                    : 'bg-yellow-100 border-yellow-200 hover:bg-yellow-200 opacity-60'
                }`}
                title="Atenci√≥n/Zona de Confort"
              />
              <button
                onClick={() => onChange('green')}
                className={`w-8 h-8 rounded-full border-2 transition-all ${
                  value === 'green' 
                    ? 'bg-green-500 border-green-700 shadow-[0_0_10px_rgba(34,197,94,0.6)] scale-110' 
                    : 'bg-green-100 border-green-200 hover:bg-green-200 opacity-60'
                }`}
                title="Fortaleza/Seguir haciendo"
              />
            </div>
          );
        };

        // --- COMPONENTE ACORDE√ìN DE SECCI√ìN ---
        const SectionAccordion = ({ section, data, onChange, isOpen, toggle }) => {
          return (
            <div className="mb-4 border border-gray-200 rounded-lg bg-white shadow-sm overflow-hidden print-break">
              <button
                onClick={toggle}
                className="w-full px-6 py-4 flex items-center justify-between bg-slate-50 hover:bg-slate-100 transition-colors"
              >
                <div className="text-left">
                  <h3 className="font-bold text-lg text-slate-800">{section.title}</h3>
                  <p className="text-sm text-slate-500">{section.description}</p>
                </div>
                {isOpen ? <Icons.ChevronUp className="text-slate-400" /> : <Icons.ChevronDown className="text-slate-400" />}
              </button>
              
              {isOpen && (
                <div className="p-6 bg-white space-y-6">
                  {section.items.map((item) => {
                    const itemData = data[item.id] || { status: null, note: '' };
                    return (
                      <div key={item.id} className="pb-4 border-b border-gray-100 last:border-0 last:pb-0">
                        <div className="flex flex-col md:flex-row md:items-start justify-between gap-4">
                          <div className="md:w-1/3">
                            <div className="flex items-center gap-2 mb-1">
                              <span className="font-medium text-slate-700">{item.label}</span>
                              <div className="group relative">
                                <Icons.Info size={16} className="text-slate-400 cursor-help" />
                                <div className="absolute left-0 bottom-6 w-64 p-2 bg-slate-800 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity z-10 pointer-events-none">
                                  {item.desc}
                                </div>
                              </div>
                            </div>
                            <p className="text-xs text-slate-500 md:hidden">{item.desc}</p>
                          </div>
                          
                          <div className="flex flex-col gap-3 md:w-2/3">
                            <div className="flex items-center gap-4">
                              <span className="text-xs font-bold text-slate-400 uppercase w-16">Estado:</span>
                              <TrafficLight 
                                value={itemData.status} 
                                onChange={(val) => onChange(section.id, item.id, 'status', val)} 
                              />
                            </div>
                            <div className="flex items-start gap-4 w-full">
                               <span className="text-xs font-bold text-slate-400 uppercase w-16 mt-2">Nota:</span>
                               <textarea
                                value={itemData.note}
                                onChange={(e) => onChange(section.id, item.id, 'note', e.target.value)}
                                placeholder="Observaciones espec√≠ficas..."
                                className="w-full text-sm p-2 border border-gray-200 rounded focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none h-16 bg-slate-50"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        };

        // --- APLICACI√ìN PRINCIPAL ---
        function ImproEvaluator() {
          const [students, setStudents] = useState([]);
          const [selectedStudentId, setSelectedStudentId] = useState(null);
          const [newStudentName, setNewStudentName] = useState('');
          const [openSections, setOpenSections] = useState({});
          const fileInputRef = useRef(null);

          // Cargar de localStorage
          useEffect(() => {
            const saved = localStorage.getItem('impro_evaluations');
            if (saved) {
              try {
                setStudents(JSON.parse(saved));
              } catch (e) {
                console.error("Error cargando datos", e);
              }
            }
          }, []);

          // Guardar en localStorage
          useEffect(() => {
            localStorage.setItem('impro_evaluations', JSON.stringify(students));
          }, [students]);

          const addStudent = (e) => {
            e.preventDefault();
            if (!newStudentName.trim()) return;
            const newStudent = {
              id: Date.now().toString(),
              name: newStudentName,
              evaluations: {},
              generalFeedback: '' // Campo nuevo
            };
            setStudents([...students, newStudent]);
            setSelectedStudentId(newStudent.id);
            setNewStudentName('');
          };

          const deleteStudent = (id) => {
            const studentName = students.find(s => s.id === id)?.name || "este alumno";
            if (confirm(`¬øEst√°s seguro de eliminar a ${studentName}?\nEsta acci√≥n no se puede deshacer.`)) {
              const newStudents = students.filter(s => s.id !== id);
              setStudents(newStudents);
              if (selectedStudentId === id) setSelectedStudentId(null);
            }
          };

          const clearAllData = () => {
            if (students.length === 0) return;
            if (confirm("‚ö†Ô∏è ¬°PELIGRO! ‚ö†Ô∏è\n\nEst√°s a punto de borrar TODOS los alumnos y sus evaluaciones.\n¬øEst√°s seguro de que quieres empezar de cero?")) {
              if (confirm("¬øDe verdad? Esto borrar√° todo permanentemente. Te recomiendo hacer un Backup primero si no lo has hecho.")) {
                setStudents([]);
                setSelectedStudentId(null);
                localStorage.removeItem('impro_evaluations');
              }
            }
          }

          const updateEvaluation = (categoryId, itemId, field, value) => {
            setStudents(students.map(student => {
              if (student.id !== selectedStudentId) return student;
              
              const currentCategory = student.evaluations[categoryId] || {};
              const currentItem = currentCategory[itemId] || { status: null, note: '' };
              
              return {
                ...student,
                evaluations: {
                  ...student.evaluations,
                  [categoryId]: {
                    ...currentCategory,
                    [itemId]: { ...currentItem, [field]: value }
                  }
                }
              };
            }));
          };
          
          const updateGeneralFeedback = (value) => {
            setStudents(students.map(student => {
              if (student.id !== selectedStudentId) return student;
              return { ...student, generalFeedback: value };
            }));
          };

          const toggleSection = (sectionId) => {
            setOpenSections(prev => ({
              ...prev,
              [sectionId]: !prev[sectionId]
            }));
          };

          const activeStudent = students.find(s => s.id === selectedStudentId);

          // --- FUNCIONES DE EXPORTACI√ìN E IMPORTACI√ìN ---

          const generateHTMLReport = (student) => {
            const getStatusEmoji = (status) => {
              if (status === 'green') return 'üü¢';
              if (status === 'yellow') return 'üü°';
              if (status === 'red') return 'üî¥';
              return '‚ö™';
            };

            let html = `
              <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
              <head><meta charset='utf-8'><title>Evaluaci√≥n Impro - ${student.name}</title>
              <style>
                body { font-family: Calibri, sans-serif; line-height: 1.5; }
                h1 { color: #2c3e50; border-bottom: 2px solid #2c3e50; }
                h2 { color: #e67e22; margin-top: 20px; }
                .item { margin-bottom: 10px; page-break-inside: avoid; }
                .label { font-weight: bold; }
                .note { font-style: italic; color: #555; margin-left: 25px; }
                .meta { color: #7f8c8d; font-size: 0.9em; }
                .feedback-box { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin-top: 10px; }
              </style>
              </head><body>
              <h1>Evaluaci√≥n de Impro: ${student.name}</h1>
              <p class="meta">Fecha: ${new Date().toLocaleDateString()}</p>
            `;

            CRITERIA.forEach(cat => {
              const catData = student.evaluations[cat.id];
              if (!catData) return;
              
              const hasData = Object.values(catData).some(item => item.status || item.note);
              if (!hasData) return;

              html += `<h2>${cat.title}</h2>`;
              
              cat.items.forEach(item => {
                const itemData = catData[item.id];
                if (itemData && (itemData.status || itemData.note)) {
                  html += `<div class='item'>`;
                  html += `<p><span class='label'>${getStatusEmoji(itemData.status)} ${item.label}</span>: ${item.desc}</p>`;
                  if (itemData.note) {
                    html += `<p class='note'>Nota: ${itemData.note}</p>`;
                  }
                  html += `</div>`;
                }
              });
            });

            if (student.generalFeedback) {
                html += `<h2>Devoluci√≥n General</h2>`;
                html += `<div class='feedback-box'><p style='white-space: pre-wrap;'>${student.generalFeedback}</p></div>`;
            }

            html += `</body></html>`;
            return html;
          };

          const downloadWordDoc = (student) => {
            const html = generateHTMLReport(student);
            const blob = new Blob(['\ufeff', html], {
                type: 'application/msword'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Evaluacion_Impro_${student.name.replace(/\s+/g, '_')}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };
          
          const exportAllToWord = () => {
             if (students.length === 0) {
                 alert("No hay alumnos para exportar.");
                 return;
             }

             let htmlBody = '';

             students.forEach((student, index) => {
                 if (index > 0) {
                     htmlBody += '<div style="page-break-before: always;"></div>';
                 }

                 const getStatusEmoji = (status) => {
                    if (status === 'green') return 'üü¢';
                    if (status === 'yellow') return 'üü°';
                    if (status === 'red') return 'üî¥';
                    return '‚ö™';
                 };

                 htmlBody += `<h1>Evaluaci√≥n de Impro: ${student.name}</h1>`;
                 htmlBody += `<p class="meta">Fecha: ${new Date().toLocaleDateString()}</p>`;

                 CRITERIA.forEach(cat => {
                     const catData = student.evaluations[cat.id];
                     if (!catData) return;
                     const hasData = Object.values(catData).some(item => item.status || item.note);
                     if (!hasData) return;

                     htmlBody += `<h2>${cat.title}</h2>`;
                     cat.items.forEach(item => {
                         const itemData = catData[item.id];
                         if (itemData && (itemData.status || itemData.note)) {
                             htmlBody += `<div class='item'>`;
                             htmlBody += `<p><span class='label'>${getStatusEmoji(itemData.status)} ${item.label}</span>: ${item.desc}</p>`;
                             if (itemData.note) {
                                 htmlBody += `<p class='note'>Nota: ${itemData.note}</p>`;
                             }
                             htmlBody += `</div>`;
                         }
                     });
                 });

                 if (student.generalFeedback) {
                      htmlBody += `<h2>Devoluci√≥n General</h2>`;
                      htmlBody += `<div class='feedback-box'><p style='white-space: pre-wrap;'>${student.generalFeedback}</p></div>`;
                 }
             });

             const fullHtml = `
               <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
               <head><meta charset='utf-8'><title>Evaluaciones Impro - Completo</title>
               <style>
                 body { font-family: Calibri, sans-serif; line-height: 1.5; }
                 h1 { color: #2c3e50; border-bottom: 2px solid #2c3e50; }
                 h2 { color: #e67e22; margin-top: 20px; }
                 .item { margin-bottom: 10px; page-break-inside: avoid; }
                 .label { font-weight: bold; }
                 .note { font-style: italic; color: #555; margin-left: 25px; }
                 .meta { color: #7f8c8d; font-size: 0.9em; }
                 .feedback-box { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin-top: 10px; }
               </style>
               </head><body>
               ${htmlBody}
               </body></html>
             `;

             const blob = new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = `Evaluaciones_Impro_Completo_${new Date().toISOString().slice(0, 10)}.doc`;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
          };

          const copyToClipboard = (student) => {
              let text = `EVALUACI√ìN DE IMPRO: ${student.name}\nFecha: ${new Date().toLocaleDateString()}\n\n`;
              CRITERIA.forEach(cat => {
                  const catData = student.evaluations[cat.id];
                  if (!catData) return;
                  const hasData = Object.values(catData).some(item => item.status || item.note);
                  if (!hasData) return;
                  text += `${cat.title.toUpperCase()}\n--------------------------------\n`;
                  cat.items.forEach(item => {
                      const itemData = catData[item.id];
                      if (itemData && (itemData.status || itemData.note)) {
                          let statusIcon = itemData.status === 'green' ? 'üü¢' : itemData.status === 'yellow' ? 'üü°' : itemData.status === 'red' ? 'üî¥' : '‚ö™';
                          text += `${statusIcon} ${item.label}\n`;
                          if(itemData.note) text += `   Nota: ${itemData.note}\n`;
                          text += '\n';
                      }
                  });
                  text += '\n';
              });
              
              if (student.generalFeedback) {
                  text += `DEVOLUCI√ìN GENERAL\n--------------------------------\n${student.generalFeedback}\n\n`;
              }

              navigator.clipboard.writeText(text);
              alert('Reporte copiado al portapapeles!');
          };

          const exportBackup = () => {
            const dataStr = JSON.stringify(students, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `impro_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          const handleImportClick = () => {
            fileInputRef.current.click();
          };

          const importBackup = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const importedData = JSON.parse(event.target.result);
                if (Array.isArray(importedData)) {
                  if (confirm('¬°Cuidado! Esto reemplazar√° tu lista actual de alumnos con la del archivo. ¬øQuieres continuar?')) {
                     setStudents(importedData);
                     alert('¬°Backup cargado con √©xito!');
                  }
                } else {
                  alert('El archivo no tiene el formato correcto.');
                }
              } catch (err) {
                alert('Error al leer el archivo. Aseg√∫rate de que sea un .json v√°lido.');
              }
            };
            reader.readAsText(file);
            e.target.value = null;
          };

          return (
            <div className="flex h-screen bg-slate-100 font-sans text-slate-800">
              
              {/* SIDEBAR - BARRA LATERAL */}
              <div className="w-80 bg-slate-900 text-white flex flex-col shadow-xl flex-shrink-0">
                <div className="p-6 border-b border-slate-700 bg-indigo-900">
                  <h1 className="text-xl font-bold flex items-center gap-2">
                    <span>üé≠</span> ImproTracker
                  </h1>
                  <p className="text-xs text-indigo-200 mt-1">Bit√°cora de Evaluaci√≥n <span className="text-indigo-400 font-mono ml-1">v1.0</span></p>
                </div>

                <div className="p-4 border-b border-slate-800">
                  <form onSubmit={addStudent} className="flex gap-2">
                    <input
                      type="text"
                      value={newStudentName}
                      onChange={(e) => setNewStudentName(e.target.value)}
                      placeholder="Nombre improvisador..."
                      className="flex-1 bg-slate-800 text-white px-3 py-2 rounded text-sm focus:outline-none focus:ring-1 focus:ring-indigo-400"
                    />
                    <button 
                      type="submit"
                      className="bg-indigo-500 hover:bg-indigo-600 p-2 rounded text-white transition-colors"
                    >
                      <Icons.UserPlus size={18} />
                    </button>
                  </form>
                </div>

                <div className="flex-1 overflow-y-auto px-2 py-2">
                  {students.length === 0 && (
                    <p className="text-center text-slate-500 text-sm mt-10 italic">No hay alumnos a√∫n.</p>
                  )}
                  {students.map(student => (
                    <div
                      key={student.id}
                      onClick={() => setSelectedStudentId(student.id)}
                      className={`group flex items-center justify-between p-3 rounded mb-1 cursor-pointer transition-all ${
                        selectedStudentId === student.id 
                          ? 'bg-indigo-600 text-white shadow-md' 
                          : 'hover:bg-slate-800 text-slate-300'
                      }`}
                    >
                      <span className="font-medium truncate">{student.name}</span>
                      <button
                        onClick={(e) => { e.stopPropagation(); deleteStudent(student.id); }}
                        className={`opacity-0 group-hover:opacity-100 hover:text-red-400 p-1 transition-opacity ${selectedStudentId === student.id ? 'text-indigo-200' : ''}`}
                        title="Borrar alumno"
                      >
                        <Icons.Trash2 size={16} />
                      </button>
                    </div>
                  ))}
                </div>
                
                {/* BACKUP & DANGER CONTROLS */}
                <div className="p-4 bg-slate-950 border-t border-slate-800 space-y-3">
                  
                  {/* Export All Button */}
                  <div>
                    <button 
                       onClick={exportAllToWord}
                       className="w-full flex items-center justify-center gap-2 bg-indigo-700 hover:bg-indigo-600 text-xs py-2 px-1 rounded transition-colors text-white font-medium mb-3 shadow-sm border border-indigo-600"
                       title="Exportar todas las evaluaciones en un solo archivo Word"
                    >
                      <Icons.FileText size={14} /> Exportar Todo (Word)
                    </button>
                  </div>

                  <div>
                    <p className="text-xs text-slate-500 mb-2 uppercase font-bold tracking-wider">Respaldo</p>
                    <div className="flex gap-2">
                      <button 
                        onClick={exportBackup}
                        className="flex-1 flex items-center justify-center gap-1 bg-slate-800 hover:bg-slate-700 text-xs py-2 px-1 rounded transition-colors text-slate-300"
                        title="Guardar archivo de respaldo"
                      >
                        <Icons.Save size={14} /> Guardar
                      </button>
                      <button 
                        onClick={handleImportClick}
                        className="flex-1 flex items-center justify-center gap-1 bg-slate-800 hover:bg-slate-700 text-xs py-2 px-1 rounded transition-colors text-slate-300"
                        title="Cargar archivo de respaldo"
                      >
                        <Icons.Upload size={14} /> Cargar
                      </button>
                      <input 
                        type="file" 
                        ref={fileInputRef}
                        onChange={importBackup} 
                        accept=".json" 
                        className="hidden" 
                      />
                    </div>
                  </div>

                  <div>
                     <button
                       onClick={clearAllData}
                       className="w-full flex items-center justify-center gap-2 bg-red-900/30 hover:bg-red-900/50 text-red-400 text-xs py-2 rounded border border-red-900/50 transition-colors"
                       title="Borrar toda la base de datos"
                     >
                       <Icons.AlertTriangle size={14} /> Borrar Todo
                     </button>
                  </div>
                </div>
              </div>

              {/* CONTENIDO PRINCIPAL */}
              <div className="flex-1 flex flex-col overflow-hidden">
                {activeStudent ? (
                  <>
                    {/* CABECERA */}
                    <div className="bg-white border-b border-gray-200 px-8 py-5 flex items-center justify-between shadow-sm z-10">
                      <div>
                        <h2 className="text-2xl font-bold text-slate-800">{activeStudent.name}</h2>
                        <p className="text-sm text-slate-500">Evaluaci√≥n en curso</p>
                      </div>
                      <div className="flex gap-3">
                        <button
                          onClick={() => copyToClipboard(activeStudent)}
                          className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50 transition-colors"
                        >
                          <Icons.Copy size={16} /> Copiar Texto
                        </button>
                        <button
                          onClick={() => downloadWordDoc(activeStudent)}
                          className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700 shadow-sm transition-colors"
                        >
                          <Icons.Download size={16} /> Exportar Word
                        </button>
                      </div>
                    </div>

                    {/* √ÅREA DEL FORMULARIO */}
                    <div className="flex-1 overflow-y-auto p-8 bg-slate-100">
                      <div className="max-w-4xl mx-auto space-y-2">
                        
                        {/* INSTRUCCIONES */}
                        <div className="bg-indigo-50 border border-indigo-100 rounded-lg p-4 mb-6 flex items-start gap-3">
                          <Icons.Info className="text-indigo-500 mt-1 shrink-0" size={20} />
                          <div className="text-sm text-indigo-800">
                            <p className="font-bold mb-1">Gu√≠a de Sem√°foro:</p>
                            <ul className="list-disc pl-4 space-y-1">
                              <li><span className="font-bold text-green-600">Verde:</span> Fortaleza. Seguir haciendo.</li>
                              <li><span className="font-bold text-yellow-600">Amarillo:</span> Zona de confort. Atenci√≥n.</li>
                              <li><span className="font-bold text-red-600">Rojo:</span> Vicio t√©cnico. A corregir.</li>
                            </ul>
                          </div>
                        </div>

                        {CRITERIA.map((section) => (
                          <SectionAccordion
                            key={section.id}
                            section={section}
                            data={activeStudent.evaluations[section.id] || {}}
                            onChange={updateEvaluation}
                            isOpen={openSections[section.id]}
                            toggle={() => toggleSection(section.id)}
                          />
                        ))}
                        
                        {/* DEVOLUCI√ìN GENERAL */}
                        <div className="bg-white border border-gray-200 rounded-lg shadow-sm p-6 mb-8 print-break">
                            <div className="flex items-center gap-2 mb-3">
                                <Icons.MessageSquare className="text-indigo-600" />
                                <h3 className="font-bold text-lg text-slate-800">Devoluci√≥n General</h3>
                            </div>
                            <p className="text-sm text-slate-500 mb-3">
                                Resumen global, objetivos para la pr√≥xima clase o palabras de aliento.
                            </p>
                            <textarea
                                value={activeStudent.generalFeedback || ''}
                                onChange={(e) => updateGeneralFeedback(e.target.value)}
                                placeholder="Escribe aqu√≠ tu devoluci√≥n general para el alumno..."
                                className="w-full p-4 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent min-h-[150px] text-slate-700 resize-y bg-slate-50"
                            />
                        </div>

                        <div className="h-20"></div> {/* Espacio extra para scroll */}
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="flex-1 flex flex-col items-center justify-center text-slate-400 bg-slate-50">
                    <div className="w-24 h-24 bg-slate-200 rounded-full flex items-center justify-center mb-6">
                      <span className="text-4xl">üé≠</span>
                    </div>
                    <h2 className="text-xl font-bold text-slate-600 mb-2">Bienvenido, Director</h2>
                    <p className="max-w-md text-center mb-8">Selecciona un improvisador del men√∫ lateral o crea uno nuevo para comenzar la evaluaci√≥n.</p>
                    <div className="flex gap-4 text-sm bg-white p-4 rounded shadow-sm border border-slate-200">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-green-500 rounded-full"></div> Fortalezas
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-yellow-400 rounded-full"></div> Atenci√≥n
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-red-500 rounded-full"></div> Correcciones
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        // Renderizar la app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ImproEvaluator />);
    </script>
</body>
</html>
